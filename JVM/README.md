# Java虚拟机

不错的文章：

+ [JVM 虚拟机入门教程](https://www.cnblogs.com/chanshuyi/category/1335567.html)



> 常见的编译型语言如C++，通常会把代码直接编译成CPU所能理解的机器码来运行。而Java为了实现“一次编译，处处运行”的特性，把编译的过程分成两部分，首先它会先由javac编译成通用的中间形式——字节码，然后再由解释器逐条将字节码解释为机器码来执行。所以在性能上，Java通常不如C++这类编译型语言。



**编译器和解释器**

> 编译器和解释器的区别在于是否编译和执行过程是否是同时进行。
>
> 编译器所干的事，将一门语言 X 编译为另一门语言 Y （可以是语言 X、高级语言、低级语言等），整个编译过程涉及词法分析、语法分析、语义分析。该过程往往由程序员在编写程序时完成。
>
> 而解释器则直接将语言 X 编写的程序在目标机器上运行。CPU就可以被当作某种指令集合的解释器。事实上，CPU的指令集合可能比我们看到的更复杂，其内部由更多的私有指令集合组成，转化为可见的公有指令集合。



**JIT编译器和AOT编译器**

> 引入解释器的思想，逐渐演化出JIT编译器（Just-in-Time Complier）：和AOT编译器（Ahead-of-Time Complier）。
>
> 两者主要是区分编译过程出现的时机。前者在程序执行时进行编译；后者则是在程序执行前进行编译。需要注意的是，JIT编译器将语言 X 转化为机器代码时，需要解释器的参与。可以认为，没有解释器，亦不存在JIT编译器。



**Java JVM：JIT编译器和解释器**

> ![001](https://github.com/winfredzen/JavaEE-Basic/blob/master/JVM/images/001.png)
>
> Java语言的编译和执行中，均涉及编译器和解释器。
>
> 首先，程序员在编写Java程序时，利用Java编译器，将Java语言编译成Java ByteCode；之后，执行过程中需要使用JVM（Java虚拟机）将ByteCode转化为机器代码。对于JVM的设计有两种，**一种使用解释器直接在目标机器上执行**，**一种则是使用JIT编译器**。前者使编译和执行的过程同时进行，对于执行次数比较少的ByteCode来说，此处的编译时间可以忽略不计；而对于频繁执行的ByteCode来说，编译时间是累加的。因此JVM通过统计ByteCode的执行次数来进行优化，其根据执行频率判断是否将ByteCode预先编译成机器代码，以节省时间，提高执行效率。



## 什么是Java虚拟机？

参考：

+ [JVM基础系列第3讲：到底什么是虚拟机？](https://www.cnblogs.com/chanshuyi/p/jvm_serial_03_the_nature_of_jvm.html)



> 与其他语言不同，Java 语言并不直接将代码编译成与系统有关的机器码，而是编译成一种特定的语言规范，这种语言规范我们称之为字节码。无论 Java 程序要在 Windows 系统，还是 Mac OSX 系统，抑或是 Linux 系统，它首先都得编译成字节码文件，之后才能运行。
>
> 但即使编译成字节码文件了，各个系统还是无法明白字节码文件的内容，这时候就需要 Java 虚拟机的帮助了。Java 虚拟机会解析字节码文件的内容，并将其翻译为各操作系统能理解的机器码。
>
> ![002](https://github.com/winfredzen/JavaEE-Basic/blob/master/JVM/images/002.png)



> 很多初学者关于 Java 虚拟机有一个误区，他们会觉得 Java 虚拟机只能运行 Java 代码。*但实际上 Java 虚拟机运行的是**字节码文件**。*换句话说，如果你用 php 语言写一段代码，并自己用特定编译器能生成符合字节码规范的字节码文件，那么 Java 虚拟机也是可以运行的。



> 到底什么是虚拟机？**其实 Java 虚拟机就是一个字节码翻译器，它将字节码文件翻译成各个系统对应的机器码，确保字节码文件能在各个系统正确运行。**





## 从源代码到机器码

参考：

+ [JVM基础系列第4讲：从源代码到机器码，发生了什么？](https://www.cnblogs.com/chanshuyi/p/jvm_serial_04_from_source_code_to_machine_code.html)



>  JDK 的安装目录里有一个 javac 工具，就是它将 Java 代码翻译成字节码，这个工具我们叫做编译器



>  JDK 的安装目录里有一个 javac 工具，就是它将 Java 代码翻译成字节码，这个工具我们叫做编译器
>
> 1. 词法、语法分析。在这个阶段，javac 编译器会对源代码的字符进行一次扫描，最终生成一个抽象的语法树。简单地说，在这个阶段 javac 编译器会搞懂我们的代码到底想要干嘛。就像我们分析一个句子一样，我们会对句子划分主谓宾，弄清楚这个句子要表达的意思一样。
> 2. 填充符号表。我们知道类之间是会互相引用的，但在编译阶段，我们无法确定其具体的地址，所以我们会使用一个符号来替代。在这个阶段做的就是类似的事情，即对抽象的类或接口进行符号填充。等到类加载阶段，javac 编译器会将符号替换成具体的内存地址。
> 3. 注解处理。我们知道 Java 是支持注解的，因此在这个阶段会对注解进行分析，根据注解的作用将其还原成具体的指令集。
> 4. 分析与字节码生成。到了这个阶段，javac 编译器便会根据上面几个阶段分析出来的结果，进行字节码的生成，最终输出为 class 文件。
>
> 我们一般称 javac 编译器为前端编译器，因为其发生在整个编译的前期



## JIT 编译器：从字节码到机器码

当源代码转化为字节码之后，其实要运行程序，有两种选择

+ 一种是使用 Java 解释器解释执行字节码
+ 另一种则是使用 JIT 编译器将字节码转化为本地机器代码。

区别：前者启动速度快但运行速度慢，而后者启动速度慢但运行速度快

在实际情况中，为了运行速度以及效率，我们通常采用两者相结合的方式进行 Java 代码的编译执行。

![003](https://github.com/winfredzen/JavaEE-Basic/blob/master/JVM/images/003.png)



> 在 HotSpot 虚拟机内置了两个即时编译器，分别称为 Client Compiler 和Server Compiler。这两种不同的编译器衍生出两种不同的编译模式，我们分别称之为：**C1 编译模式**，**C2 编译模式**。
>
> **那么 C1 编译模式和 C2 编译模式有什么区别呢？**
>
> C1 编译模式会将字节码编译为本地代码，进行简单、可靠的优化，如有必要将加入性能监控的逻辑。而 C2 编译模式，也是将字节码编译为本地代码，但是会启用一些编译耗时较长的优化，甚至会根据性能监控信息进行一些不可靠的激进优化。
>
> 简单地说 C1 编译模式做的优化相对比较保守，其编译速度相比 C2 较快。而 C2 编译模式会做一些激进的优化，并且会根据性能监控做针对性优化，所以其编译质量相对较好，但是耗时更长。
>
> **那么到底应该选择 C1 编译模式还是 C2 编译模式呢？**
>
> 实际上对于 HotSpot 虚拟机来说，其一共有三种运行模式可选，分别是：
>
> - 混合模式（Mixed Mode） 。即 C1 和 C2 两种模式混合起来使用，这是默认的运行模式。如果你想单独使用 C1 模式或 C2 模式，使用 `-client` 或 `-server` 打开即可。
> - 解释模式（Interpreted Mode）。即所有代码都解释执行，使用 `-Xint` 参数可以打开这个模式。
> - 编译模式（Compiled Mode）。 此模式优先采用编译，但是无法编译时也会解释执行，使用 `-Xcomp` 打开这种模式。
>
> 在命令行中输入 `java -version` 可以看到，我机器上的虚拟机使用 Mixed Mode 运行模式。
>
> ![004](https://github.com/winfredzen/JavaEE-Basic/blob/master/JVM/images/004.png)



## AOT 编译器：源代码到机器码

AOT 编译器的基本思想是：在程序执行前生成 Java 方法的本地代码，以便在程序运行时直接使用本地代码。

但是 Java 语言本身的动态特性带来了额外的复杂性，影响了 Java 程序静态编译代码的质量。例如 Java 语言中的动态类加载，因为 AOT 是在程序运行前编译的，所以无法获知这一信息，所以会导致一些问题的产生。类似的问题还有很多，这里就不一一举例了。

总的来说，AOT 编译器从编译质量上来看，肯定比不上 JIT 编译器。其存在的目的在于避免 JIT 编译器的运行时性能消耗或内存消耗，或者避免解释程序的早期性能开销。

在运行速度上来说，AOT 编译器编译出来的代码比 JIT 编译出来的慢，但是比解释执行的快。而编译时间上，AOT 也是一个始终的速度。所以说，AOT 编译器的存在是 JVM 牺牲质量换取性能的一种策略。就如 JVM 其运行模式中选择 Mixed 混合模式一样，使用 C1 编译模式只进行简单的优化，而 C2 编译模式则进行较为激进的优化。充分利用两种模式的优点，从而达到最优的运行效率。



## 总结

在 JVM 中有三个非常重要的编译器，它们分别是：**前端编译器、JIT 编译器、AOT 编译器。**

前端编译器，最常见的就是我们的 javac 编译器，其将 Java 源代码编译为 Java 字节码文件。JIT 即时编译器，最常见的是 HotSpot 虚拟机中的 Client Compiler 和 Server Compiler，其将 Java 字节码编译为本地机器代码。而 AOT 编译器则能将源代码直接编译为本地机器码。这三种编译器的编译速度和编译质量如下：

- 编译速度上，解释执行 > AOT 编译器 > JIT 编译器。
- 编译质量上，JIT 编译器 > AOT 编译器 > 解释执行。

而在 JVM 中，通过这几种不同方式的配合，使得 JVM 的编译质量和运行速度达到最优的状态。













































